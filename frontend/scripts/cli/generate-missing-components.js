#!/usr/bin/env node

/**
 * Generate Missing Component Scripts
 * Creates scripts for pages and other missing components needed by the build
 */

const fs = require('fs').promises;
const ScaffoldGenerator = require('./ScaffoldGenerator.cjs');

class MissingComponentGenerator {
  constructor() {
    this.scaffoldGenerator = new ScaffoldGenerator();
  }

  async generateAllMissingScripts() {
    console.log('üîß Generating Missing Component Scripts');
    console.log('=====================================\n');

    const missingCategories = [
      {
        name: 'pages',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/pages',
        scriptName: 'create-detox-pages',
        description: 'Pages and route components',
        targetDir: 'src/pages/'
      },
      {
        name: 'sidebar-components',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/components/sidebar',
        scriptName: 'create-detox-sidebar-components',
        description: 'Sidebar navigation components',
        targetDir: 'src/components/sidebar/'
      },
      {
        name: 'menu-components',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/components/menu',
        scriptName: 'create-detox-menu-components',
        description: 'Menu and dropdown components',
        targetDir: 'src/components/menu/'
      },
      {
        name: 'titlebar-components',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/components/titlebar',
        scriptName: 'create-detox-titlebar-components',
        description: 'Title bar and tab components',
        targetDir: 'src/components/titlebar/'
      },
      {
        name: 'search-components',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/components/search',
        scriptName: 'create-detox-search-components',
        description: 'Search and spotlight components',
        targetDir: 'src/components/search/'
      },
      {
        name: 'contexts',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/contexts',
        scriptName: 'create-detox-contexts',
        description: 'React contexts for state management',
        targetDir: 'src/contexts/'
      },
      {
        name: 'utils',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/utils',
        scriptName: 'create-detox-utils',
        description: 'Utility functions and helpers',
        targetDir: 'src/utils/'
      },
      {
        name: 'data',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/data',
        scriptName: 'create-detox-data',
        description: 'Data providers and mock data',
        targetDir: 'src/data/'
      },
      {
        name: 'lib',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/lib',
        scriptName: 'create-detox-lib',
        description: 'Library utilities and helpers',
        targetDir: 'src/lib/'
      },
      {
        name: 'electron-types',
        sourceDir: '/mnt/c/Projects/task-writer/frontend/app/src/types',
        scriptName: 'create-detox-electron-types',
        description: 'TypeScript type definitions',
        targetDir: 'src/types/'
      }
    ];

    for (const category of missingCategories) {
      await this.generateCategoryScript(category);
    }

    // Update the master script to include missing components
    await this.updateMasterScript(missingCategories);

    console.log('\n‚úÖ All missing component scripts generated!');
    console.log('üì¶ Run the updated master script to generate all components');
  }

  async generateCategoryScript(category) {
    try {
      console.log(`üì¶ Generating ${category.name} script...`);

      // Check if source exists
      try {
        await fs.access(category.sourceDir);
      } catch {
        console.log(`   ‚ö†Ô∏è  Source directory not found: ${category.sourceDir}`);
        return;
      }

      const result = await this.scaffoldGenerator.generateScaffold(category.sourceDir, {
        targetOS: 'cross-platform',
        includeContent: true,
        scriptName: category.scriptName,
        outputFormat: 'bash',
        supportedFileTypes: ['.tsx', '.ts', '.jsx', '.js'],
        excludeNodeModules: true,
        createDirectoriesOnly: false
      });

      let content = result.scaffolds[0].content;
      
      // Fix file paths to use the correct target directory
      content = content.replace(/cat > "([^"]+)"/g, `cat > "${category.targetDir}$1"`);
      
      // Create the script with proper header
      const script = `#!/bin/bash

#============================================================================
# Detox Tool Component Generator Script
# Category: ${category.name}
# Description: ${category.description}
# Generated by: Task-Writer ScaffoldGenerator
#============================================================================

echo "üöÄ Creating ${category.name} for detox-tool..."
echo "üìÅ Target: ./src/"

# Create target directory structure
mkdir -p ${category.targetDir}
mkdir -p src/components/search
mkdir -p src/components/sidebar
mkdir -p src/components/menu
mkdir -p src/components/titlebar
mkdir -p src/pages/settings
mkdir -p src/contexts
mkdir -p src/utils
mkdir -p src/data
mkdir -p src/lib
mkdir -p src/types

${content}

echo "‚úÖ ${category.name} components created successfully!"
`;

      const scriptPath = `/mnt/c/projects/detox-tool/frontend/docs/${category.scriptName}.sh`;
      await fs.writeFile(scriptPath, script);
      
      // Make executable
      const { exec } = require('child_process');
      exec(`chmod +x "${scriptPath}"`);

      console.log(`   ‚úÖ Generated ${category.scriptName}.sh`);

    } catch (error) {
      console.log(`   ‚ùå Failed to generate ${category.name}: ${error.message}`);
    }
  }

  async updateMasterScript(newCategories) {
    try {
      const masterPath = '/mnt/c/projects/detox-tool/frontend/docs/run-all-component-scripts.sh';
      let masterContent = await fs.readFile(masterPath, 'utf-8');

      // Add new scripts to the array
      const newScripts = newCategories.map(cat => `"${cat.scriptName}.sh"`);
      
      // Find the scripts array and update it
      const scriptsArrayMatch = masterContent.match(/scripts=\(\s*([\s\S]*?)\s*\)/);
      if (scriptsArrayMatch) {
        const currentScripts = scriptsArrayMatch[1]
          .split('\n')
          .map(line => line.trim())
          .filter(line => line && !line.startsWith('#'))
          .map(line => line.replace(/"/g, ''));

        const allScripts = [
          ...currentScripts,
          ...newScripts.map(s => s.replace(/"/g, ''))
        ];

        const newScriptsArray = `scripts=(\n    ${allScripts.map(s => `"${s}"`).join('\n    ')}\n)`;
        
        masterContent = masterContent.replace(/scripts=\(\s*[\s\S]*?\s*\)/, newScriptsArray);
        
        await fs.writeFile(masterPath, masterContent);
        console.log('   ‚úÖ Updated master script with missing components');
      }

    } catch (error) {
      console.log(`   ‚ö†Ô∏è  Could not update master script: ${error.message}`);
    }
  }
}

// Run if called directly
async function main() {
  const generator = new MissingComponentGenerator();
  await generator.generateAllMissingScripts();
}

if (require.main === module) {
  main().catch(console.error);
}

module.exports = MissingComponentGenerator;